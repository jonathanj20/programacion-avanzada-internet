<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <canvas id="miCanvas">Canvas no está disponible para tu navegador</canvas>
    <style>
        #miCanvas {
            width: 600px;
            height: 600px;
            border: 2px solid #000;
            background: #EDEDED;
        }
    </style>
    <script>
        const canvas = document.getElementById('miCanvas');
        const ctx = canvas.getContext('2d');
        let x = 20, y = 20, dir = 0, w=20, h=10;
        let t_x = 50, t_y=50, t_w=10, t_h=5;
        let m_x = 70, m_y=20, m_w=160, m_h=10;
        let oldX = 0, oldY = 0;

        //esta variable es para detectar cuando está tocando el muro
        let tocaMuro = false;
        

        document.addEventListener("keydown", (e) => {
            switch (e.keyCode) {
                case 39:
                    dir = e.keyCode;
                    //derecha
                    break;
                case 37:
                    dir = e.keyCode;
                    //izquierda
                    break;
                case 38:
                    dir = e.keyCode;
                    //arriba
                    break;
                case 40:
                    dir = e.keyCode;
                    //abajo
                    break;
            }

            // oldX = x;
            // oldY = y;
            // console.log(oldX);
            // console.log(oldY);
            //update();
        });

        function update() {
            switch (dir) {
                case 39:
                    x += 3;
                    if (x > 550) { x = -50; };
                    //if(y < -50){ y = 600; }
                    //ctx.fillStyle = getRandomColor();
                    //ctx.fillRect(x, y, 40, 20);
                    //derecha
                    break;
                case 37:
                    x -= 3;
                    if (x < -50) { x = 550; };
                    //ctx.fillStyle = getRandomColor();
                    //ctx.fillRect(x, y, 40, 20);
                    //izquierda
                    break;
                case 38:
                    y -= 3;
                    if (y < -50) { y = 550; };
                    //ctx.fillStyle = getRandomColor();
                    //ctx.fillRect(x, y, 40, 20);
                    //arriba
                    break;
                case 40:
                    y += 3;
                    if (y > 550) { y = -50; };
                    //ctx.fillStyle = getRandomColor();
                    //ctx.fillRect(x, y, 40, 20);
                    //abajo
                    break;
            }

            /*constantemente se estará verificando si el cuadrito está tocando el muro,
            si no lo toca estará guardando las coordenadas en una variable*/
            if(!tocaMuro){
                oldX = x;
                oldY = y;
            }

            repaint();
            window.requestAnimationFrame(update);
        }

        function repaint() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 600, 600);
            ctx.fillStyle = getRandomColor();
            ctx.fillRect(x, y, w, h);
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#000';
            ctx.fillRect(t_x,t_y,t_w,t_h);

            if(x < t_x + t_w &&  x + w > t_x && y < t_y + t_h && y + h > t_y){ 
                t_x = Math.floor(Math.random() * (290 - 0 + 1) + 0);
                t_y = Math.floor(Math.random() * (145 - 0 + 1) + 0);
            }

            //muro
            ctx.fillStyle = 'gray';
            ctx.fillRect(m_x,m_y,m_w,m_h);

            //cuando toca el muro, las posiciones originales serán las que eran antes de tocar el muro
            if(x < m_x + m_w &&  x + w > m_x && y < m_y + m_h && y + h > m_y){
                tocaMuro = true;
                x=oldX;
                y=oldY;
            } else{
                tocaMuro = false;
            }
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 256); // Valor de rojo entre 0 y 255
            const g = Math.floor(Math.random() * 256); // Valor de verde entre 0 y 255
            const b = Math.floor(Math.random() * 256); // Valor de azul entre 0 y 255
            const alpha = 0.9; // Opacidad fija, ajusta este valor según lo que necesites

            return `rgba(${r},${g},${b},${alpha})`;
        }

        window.requestAnimationFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 17);
                };
        }());

        window.requestAnimationFrame(update);

        function pintarCuadro(){
            ctx.fillStyle = '#000';
            ctx.fillRect(Math.floor(Math.random() * (290 - 0 + 1) + 0),Math.floor(Math.random() * (145 - 0 + 1) + 0),10,5);
        }
    </script>
</body>

</html>